---
interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Citelines' } = Astro.props;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <title>{title} | Citelines</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: system-ui, sans-serif;
        line-height: 1.6;
        color: #1a1a1a;
        background: #fff;
      }

      nav {
        border-bottom: 1px solid #e5e5e5;
        padding: 0 1.5rem;
        display: flex;
        align-items: center;
        gap: 2rem;
        height: 3.5rem;
      }

      nav .brand {
        font-weight: 700;
        font-size: 1.125rem;
        color: inherit;
        text-decoration: none;
      }

      nav a {
        color: #555;
        text-decoration: none;
        font-size: 0.9rem;
      }

      nav a:hover, nav a[aria-current="page"] {
        color: #1a1a1a;
      }

      nav .account-wrapper {
        margin-left: auto;
        position: relative;
      }

      nav .account-btn {
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        color: #555;
        padding: 4px;
      }

      nav .account-btn:hover {
        color: #1a1a1a;
      }

      .auth-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        width: 320px;
        background: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.12);
        z-index: 100;
        padding: 1.25rem;
      }

      .auth-dropdown.open {
        display: block;
      }

      .auth-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e5e5e5;
      }

      .auth-tab {
        flex: 1;
        background: none;
        border: none;
        padding: 0.5rem 0;
        cursor: pointer;
        font-size: 0.9rem;
        color: #888;
        border-bottom: 2px solid transparent;
        transition: color 0.15s, border-color 0.15s;
      }

      .auth-tab:hover {
        color: #1a1a1a;
      }

      .auth-tab.active {
        color: #1a1a1a;
        border-bottom-color: #1a1a1a;
      }

      .auth-view {
        display: none;
      }

      .auth-view.active {
        display: block;
      }

      .auth-field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-bottom: 0.75rem;
      }

      .auth-field label {
        font-size: 0.8rem;
        color: #555;
      }

      .auth-field input {
        padding: 0.5rem 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.15s;
      }

      .auth-field input:focus {
        border-color: #1a1a1a;
      }

      .auth-submit {
        width: 100%;
        padding: 0.55rem;
        background: #1a1a1a;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        margin-top: 0.25rem;
      }

      .auth-submit:hover {
        background: #333;
      }

      .auth-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .auth-error {
        color: #c00;
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
        display: none;
      }

      .auth-error.visible {
        display: block;
      }

      .auth-success {
        text-align: center;
        padding: 1rem 0;
        font-size: 0.9rem;
        color: #555;
        line-height: 1.5;
      }

      .auth-logged-in {
        text-align: center;
        padding: 0.5rem 0;
      }

      .auth-logged-in .display-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.75rem;
      }

      .auth-logged-in .dash-link {
        display: inline-block;
        margin-bottom: 0.75rem;
        color: #555;
        text-decoration: none;
        font-size: 0.9rem;
      }

      .auth-logged-in .dash-link:hover {
        color: #1a1a1a;
        text-decoration: underline;
      }

      .auth-logout {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.4rem 1.2rem;
        font-size: 0.85rem;
        cursor: pointer;
        color: #555;
      }

      .auth-logout:hover {
        border-color: #999;
        color: #1a1a1a;
      }

      main {
        max-width: 860px;
        margin: 0 auto;
        padding: 3rem 1.5rem;
      }

      footer {
        border-top: 1px solid #e5e5e5;
        padding: 1.5rem;
        text-align: center;
        color: #888;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <nav>
      <a class="brand" href="/">Citelines</a>
      <a href="/mission" aria-current={Astro.url.pathname === '/mission' ? 'page' : undefined}>Mission</a>
      <a href="/team" aria-current={Astro.url.pathname === '/team' ? 'page' : undefined}>Team</a>
      <a href="/docs" aria-current={Astro.url.pathname === '/docs' ? 'page' : undefined}>Documentation</a>
      <a href="/get-involved" aria-current={Astro.url.pathname === '/get-involved' ? 'page' : undefined}>Get Involved</a>
      <a href="/blog" aria-current={Astro.url.pathname === '/blog' ? 'page' : undefined}>Blog</a>
      <div class="account-wrapper">
        <button class="account-btn" id="account-toggle" aria-label="Log in / Sign up">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="8" r="4" />
            <path d="M20 21a8 8 0 1 0-16 0" />
          </svg>
        </button>
        <div class="auth-dropdown" id="auth-dropdown">
          <!-- Sign Up / Log In views -->
          <div id="auth-forms">
            <div class="auth-tabs">
              <button class="auth-tab active" data-tab="signup">Sign Up</button>
              <button class="auth-tab" data-tab="login">Log In</button>
            </div>
            <div class="auth-error" id="auth-error"></div>

            <div class="auth-view active" id="view-signup">
              <form id="signup-form">
                <div class="auth-field">
                  <label for="signup-name">Display Name</label>
                  <input id="signup-name" type="text" required autocomplete="name" />
                </div>
                <div class="auth-field">
                  <label for="signup-email">Email</label>
                  <input id="signup-email" type="email" required autocomplete="email" />
                </div>
                <div class="auth-field">
                  <label for="signup-password">Password</label>
                  <input id="signup-password" type="password" required autocomplete="new-password" minlength="8" />
                </div>
                <div class="auth-field">
                  <label for="signup-confirm">Confirm Password</label>
                  <input id="signup-confirm" type="password" required autocomplete="new-password" minlength="8" />
                </div>
                <button type="submit" class="auth-submit">Sign Up</button>
              </form>
            </div>

            <div class="auth-view" id="view-login">
              <form id="login-form">
                <div class="auth-field">
                  <label for="login-email">Email</label>
                  <input id="login-email" type="email" required autocomplete="email" />
                </div>
                <div class="auth-field">
                  <label for="login-password">Password</label>
                  <input id="login-password" type="password" required autocomplete="current-password" />
                </div>
                <button type="submit" class="auth-submit">Log In</button>
              </form>
            </div>
          </div>

          <!-- Post-signup verification message -->
          <div class="auth-view" id="view-verify">
            <div class="auth-success">
              <strong>Check your email</strong><br />
              We sent a verification link. Please verify your email before logging in.
            </div>
            <button class="auth-tab" style="width:100%;margin-top:0.75rem;border:1px solid #ddd;border-radius:4px;padding:0.4rem" id="verify-to-login">Go to Log In</button>
          </div>

          <!-- Logged-in state -->
          <div class="auth-view" id="view-logged-in">
            <div class="auth-logged-in">
              <div class="display-name" id="user-display-name"></div>
              <a href="/dashboard" class="dash-link">Dashboard</a><br />
              <button class="auth-logout" id="logout-btn">Log Out</button>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <main>
      <slot />
    </main>
    <footer>
      &copy; {new Date().getFullYear()} Citelines
    </footer>
    <script>
      const API = '/api';
      const toggle = document.getElementById('account-toggle');
      const dropdown = document.getElementById('auth-dropdown');
      const tabs = dropdown.querySelectorAll('.auth-tab[data-tab]');
      const errorEl = document.getElementById('auth-error');
      const signupForm = document.getElementById('signup-form');
      const loginForm = document.getElementById('login-form');
      const formsWrapper = document.getElementById('auth-forms');
      const viewSignup = document.getElementById('view-signup');
      const viewLogin = document.getElementById('view-login');
      const viewVerify = document.getElementById('view-verify');
      const viewLoggedIn = document.getElementById('view-logged-in');
      const displayNameEl = document.getElementById('user-display-name');
      const logoutBtn = document.getElementById('logout-btn');
      const verifyToLogin = document.getElementById('verify-to-login');

      function showError(msg) {
        errorEl.textContent = msg;
        errorEl.classList.add('visible');
      }

      function hideError() {
        errorEl.textContent = '';
        errorEl.classList.remove('visible');
      }

      function setView(view) {
        [viewSignup, viewLogin, viewVerify, viewLoggedIn].forEach(v => v.classList.remove('active'));
        formsWrapper.style.display = (view === 'verify' || view === 'logged-in') ? 'none' : '';
        if (view === 'signup') { viewSignup.classList.add('active'); }
        else if (view === 'login') { viewLogin.classList.add('active'); }
        else if (view === 'verify') { viewVerify.classList.add('active'); }
        else if (view === 'logged-in') { viewLoggedIn.classList.add('active'); }

        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === view));
        hideError();
      }

      function checkAuth() {
        const token = localStorage.getItem('citelines_token');
        const user = localStorage.getItem('citelines_user');
        if (token && user) {
          try {
            const u = JSON.parse(user);
            displayNameEl.textContent = u.displayName || u.email;
            setView('logged-in');
          } catch { setView('signup'); }
        } else {
          setView('signup');
        }
      }

      // Toggle dropdown
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = dropdown.classList.toggle('open');
        if (isOpen) checkAuth();
      });

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && e.target !== toggle) {
          dropdown.classList.remove('open');
        }
      });

      // Tab switching
      tabs.forEach(tab => {
        tab.addEventListener('click', () => setView(tab.dataset.tab));
      });

      // "Go to Log In" from verification view
      verifyToLogin.addEventListener('click', () => {
        formsWrapper.style.display = '';
        setView('login');
      });

      // Sign Up
      signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        const displayName = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value;
        const confirm = document.getElementById('signup-confirm').value;

        if (password !== confirm) { showError('Passwords do not match.'); return; }

        const btn = signupForm.querySelector('.auth-submit');
        btn.disabled = true;
        btn.textContent = 'Signing up…';
        try {
          const res = await fetch(`${API}/auth/register-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, displayName }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || data.error || 'Sign-up failed');
          signupForm.reset();
          setView('verify');
        } catch (err) {
          showError(err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Sign Up';
        }
      });

      // Log In
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;

        const btn = loginForm.querySelector('.auth-submit');
        btn.disabled = true;
        btn.textContent = 'Logging in…';
        try {
          const res = await fetch(`${API}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || data.error || 'Login failed');
          localStorage.setItem('citelines_token', data.token);
          localStorage.setItem('citelines_user', JSON.stringify(data.user));
          loginForm.reset();
          setView('logged-in');
          displayNameEl.textContent = data.user.displayName || data.user.email;
        } catch (err) {
          showError(err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Log In';
        }
      });

      // Log Out
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('citelines_token');
        localStorage.removeItem('citelines_user');
        setView('signup');
      });

      // Init: check auth on load (for showing logged-in state if dropdown opens)
      checkAuth();
    </script>
  </body>
</html>
