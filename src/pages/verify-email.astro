---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Verify Email" description="Verify your Citelines email address">
  <div id="status" style="text-align: center; padding: 2rem 0;">
    <p>Verifying your email&hellip;</p>
  </div>

  <script>
    const API_URL = 'https://youtube-annotator-production.up.railway.app';

    async function verify() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const el = document.getElementById('status');

      if (!token) {
        el.innerHTML = '<h1>Invalid Link</h1><p>No verification token found. Please use the link from your email.</p>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/verify-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });

        const data = await res.json();

        if (res.ok) {
          el.innerHTML = '<h1>Email Verified!</h1><p>Your email has been verified. You can close this tab and sign in to the extension.</p>';
        } else {
          el.innerHTML = `<h1>Verification Failed</h1><p>${data.message || 'This link has expired or is invalid. Please request a new one.'}</p>`;
        }
      } catch (err) {
        el.innerHTML = '<h1>Something went wrong</h1><p>Please try again or contact support.</p>';
      }
    }

    verify();
  </script>
</Layout>
